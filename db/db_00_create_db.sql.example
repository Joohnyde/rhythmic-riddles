-- Define variable
\set db_name rhytmicriddles
\set db_user rhytmicriddles
\set db_pass change_me

-- Drop database (must be outside transaction)
DROP DATABASE IF EXISTS :db_name;

-- Create user (role)
DO
$$
BEGIN
   IF NOT EXISTS (
      SELECT FROM pg_catalog.pg_roles WHERE rolname = :'db_user'
   ) THEN
      EXECUTE format('CREATE ROLE %I LOGIN PASSWORD %L', :'db_user', :'db_pass');
   END IF;
END
$$;

-- Create database owned by the user
CREATE DATABASE :db_name OWNER :db_user;

-- Connect to the new database
\connect :db_name

-- Make sure user owns public schema
ALTER SCHEMA public OWNER TO :db_user;

-- Grant full privileges on database
GRANT ALL PRIVILEGES ON DATABASE :db_name TO :db_user;

-- Allow user to create in public schema
GRANT ALL ON SCHEMA public TO :db_user;

-- Ensure future tables/sequences/functions are accessible
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT ALL ON TABLES TO :db_user;

ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT ALL ON SEQUENCES TO :db_user;

ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT ALL ON FUNCTIONS TO :db_user;

